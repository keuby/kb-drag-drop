/**
 * kb-drag-drop v1.0.0
 * release at 2020-8-8
 * by Knight Chen
 * github https://github.com/keuby/kb-drag-drop#readme
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("hammerjs")):"function"==typeof define&&define.amd?define(["exports","hammerjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).KbDragDrop={},t.Hammer)}(this,function(t,o){"use strict";o=o&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o;var n="kb-drag-item",r="kb-drag-list",e="kb-drag",a={click:"tap",dragstart:"panstart",dragmove:"panmove",dragend:"panend",dragcancel:"pancancel"},i=(s.prototype.isEntered=function(t){var e=t.x,n=t.y,r=this.instance.el.getBoundingClientRect(),i=r.left,o=r.right,s=r.top,a=r.bottom;return i<e&&e<o&&s<n&&n<a},s);function s(t,e){this.instance=t,this.record=e}var c=(l.getInstance=function(){return this.instance},Object.defineProperty(l.prototype,"dragData",{get:function(){var t={data:this.selectable?Array.from(this.selectedItems||[]).map(function(t){return t.data}):this.draggingItem&&this.draggingItem.data,from:this.draggingItem.dragList.data};return null!=this.enteredObserverRecord&&(t.current=this.enteredObserverRecord.instance.data),t},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"dropData",{get:function(){return{data:this.selectable?Array.from(this.selectedItems||[]).map(function(t){return t.data}):this.draggingItem&&this.draggingItem.data,from:this.draggingItem.dragList.data,to:this.enteredObserverRecord.instance.data}},enumerable:!1,configurable:!0}),l.prototype.emitElementSelect=function(t,e){null==this.selectedGroup?this.selectedGroup=t.group:this.selectedGroup!==t.group&&this.cleanSelectedItems(),e?this.selectedItems.add(t):this.selectedItems.delete(t),this.emitSelectEvent(t,{selected:e}),this.emitSelectEvent(t.dragList,{selectedItems:Array.from(this.selectedItems).map(function(t){return t.data})})},l.prototype.emitDragStart=function(t){var e,n;null!=t&&(e=t.selectable,n=this.selectable?this.selectedGroup:t.group,this.dragging=!0,this.selectable=e,this.draggingItem=t,this.draggingObserverRecords=this.observerRecords.filter(function(t){var e=t.instance.group;return null!=e&&e===n}),this.emitDragEvent("dragstart",this.dragData))},l.prototype.emitDragMove=function(e){var t;if(0!==(null===(t=this.draggingObserverRecords)||void 0===t?void 0:t.length)){var n=this.draggingObserverRecords.find(function(t){return t.isEntered(e.center)});if(null!=n){if(this.enteredObserverRecord===n)return this.dispatchEvent(n.instance,"dragover",this.dragData);null!=this.enteredObserverRecord&&this.callHandler(this.enteredObserverRecord,"dragleave",e),this.enteredObserverRecord=n,this.callHandler(n,"dragenter",e)}else null!=this.enteredObserverRecord&&(this.callHandler(this.enteredObserverRecord,"dragleave",e),this.enteredObserverRecord=null)}},l.prototype.emitDragEnd=function(t){this.dragging&&(this.emitDragEvent("dragend",this.dragData),null!=this.enteredObserverRecord&&(this.emitDragEvent("drop",this.dropData),this.callHandler(this.enteredObserverRecord,"dragleave",t)),this.dragging=!1,this.draggingItem=null,this.draggingObserverRecords=null,this.enteredObserverRecord=null,this.cleanSelectedItems())},l.prototype.addObserver=function(e,t){var n,r=this.observerRecords;r.some(function(t){return t.instance===e})||(n=new i(e,t),r.push(n))},l.prototype.cleanSelectedItems=function(){this.selectable=null,this.selectedGroup=null,this.selectedItems.forEach(function(t){return t.selected=!1})},l.prototype.callHandler=function(t,e,n){var r=t.record,i=t.instance,o=r[e];null!=o&&"function"==typeof i[o]&&i[o](n),this.dispatchEvent(i,e,this.dragData)},l.prototype.emitDragEvent=function(t,e){this.emitDragItemEvent(t,e),this.emitDragListEvent(t,e)},l.prototype.emitSelectEvent=function(e,t){var n=this;this.selectEmitRecord.has(e)||setTimeout(function(){var t=n.selectEmitRecord.get(e);n.dispatchEvent(e,"select",t),n.selectEmitRecord.delete(e)},30),this.selectEmitRecord.set(e,t)},l.prototype.emitDragItemEvent=function(t,e){this.selectable?this.broadcastEvent(this.selectedItems,t,e):this.dispatchEvent(this.draggingItem,t,e)},l.prototype.emitDragListEvent=function(t,e){this.dispatchEvent(this.draggingItem.dragList,t,e)},l.prototype.dispatchEvent=function(t,e,n){t.dispatchEvent(e,n)},l.prototype.broadcastEvent=function(t,e,n){t.forEach(function(t){return t.dispatchEvent(e,n)})},l.instance=new l,l);function l(){this.dragging=!1,this.observerRecords=[],this.selectedItems=new Set,this.selectEmitRecord=new Map,this.enteredObserverRecord=null}function d(t,e){"function"==typeof t.__init__&&t.__init__(),null!=e&&"function"==typeof t.on&&t.on(e)}function u(t){"function"==typeof t.__dispose__&&t.__dispose__(),"function"==typeof t.off&&t.off()}function p(t){var e,r,i;r=(e=t).__record__,i=e.__compute__,e.prototype.__init__=function(){var t,n=this;null!=this.el&&(null!=r&&(this.__manager__=new o(this.el),t=Object.keys(r).join(" "),this.__manager__.on(t,function(t){var e=r[t.type];n[e](t)})),null!=i&&c.getInstance().addObserver(this,i))},e.prototype.__dispose__=function(){null!=this.__manager__&&(this.__manager__.destroy(),this.__manager__=null)}}function g(s){return function(t,e){var n,r,i,o=t.constructor;n=o,i=e,(r=s)in a?(r=a[r],(n.__record__||(n.__record__={}))[r]=i):(n.__compute__||(n.__compute__={}))[r]=i}}function h(t,e){Object.defineProperty(t,e,{get:function(){return c.getInstance()}})}var f=function(t,e){return(f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function m(t,e){function n(){this.constructor=t}f(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function v(t,e,n,r){var i,o=arguments.length,s=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;0<=a;a--)(i=t[a])&&(s=(o<3?i(s):3<o?i(e,n,s):i(e,n))||s);return 3<o&&s&&Object.defineProperty(e,n,s),s}var y=(b.prototype.noticeDirty=function(t){var e=this.search(t);e&&e.makeDirty()},b.prototype.search=function(t){for(var e=this.el.parentElement;null!=e;){var n=e.instance;if(null!=n&&n instanceof t)return n;e=e.parentElement}return null},b.prototype.on=function(t,e){"function"==typeof t?this.eventRecord.default=t:this.eventRecord[t]=e},b.prototype.off=function(t){null==t&&(t="default"),this.eventRecord[t]=null},b.prototype.dispatchEvent=function(t,e){var n,r;"function"==typeof this.eventRecord[t]?(n=this.eventRecord[t],r=[e]):"function"==typeof this.eventRecord.default&&(n=this.eventRecord.default,r=[t,e]),null!=n&&n.apply(this,r)},b);function b(t){this.el=t,this.eventRecord=Object.create(null)}var _,E=(m(D,_=y),Object.defineProperty(D.prototype,"items",{get:function(){return this.dirty&&this.initItems(),this._items},enumerable:!1,configurable:!0}),D.prototype.makeDirty=function(){this.dirty=!0},D.prototype.initItems=function(){for(var t=[],e=0;e<this.collection.length;e++){var n=this.collection[e];t.push(n.instance)}this._items=t,this.dirty=!1},D);function D(){var t=null!==_&&_.apply(this,arguments)||this;return t.dirty=!0,t}var R,I={id:0,getGroupId:function(){return"kb-drag-group-"+this.id++}},O=(m(L,R=E),L.prototype.collect=function(){this.collection=this.el.querySelectorAll("["+r+"]"),this.initItems()},L.prototype.initItems=function(){R.prototype.initItems.call(this);for(var t=0,e=this.items;t<e.length;t++){e[t].setGroupInstance(this)}},L.prototype.destory=function(){},L);function L(){var t=null!==R&&R.apply(this,arguments)||this;return t.name=I.getGroupId(),t}var N,P=e+"-entered",S=(m(j,N=E),Object.defineProperty(j.prototype,"group",{get:function(){return null!=this.groupName?this.groupName:null!=this.dragListGroup?this.dragListGroup.name:void 0},enumerable:!1,configurable:!0}),j.prototype.setGroupInstance=function(t){this.dragListGroup=t},j.prototype.collect=function(){this.collection=this.el.querySelectorAll("["+n+"]"),this.initItems()},j.prototype.handleDragEnter=function(t){this.el.classList.add(P)},j.prototype.handleDragLeave=function(t){this.el.classList.remove(P)},j.prototype.initItems=function(){N.prototype.initItems.call(this);for(var t=0,e=this.items;t<e.length;t++){e[t].setDragList(this)}},v([g("dragenter")],j.prototype,"handleDragEnter",null),v([g("dragleave")],j.prototype,"handleDragLeave",null),v([p],j));function j(t){var e=N.call(this,t)||this;return e.selectable=!1,e.el.setAttribute(r,""),e}var x,A=e+"-item-selected",w=e+"-item-dragging",G=e+"-item-inserted",T=(m(k,x=y),Object.defineProperty(k.prototype,"group",{get:function(){return this.dragList&&this.dragList.group},enumerable:!1,configurable:!0}),Object.defineProperty(k.prototype,"selectable",{get:function(){return null!=this.dragList&&this.dragList.selectable},enumerable:!1,configurable:!0}),Object.defineProperty(k.prototype,"selected",{get:function(){return this.el.classList.contains(A)},set:function(t){t?this.el.classList.add(A):this.el.classList.remove(A),this.manager.emitElementSelect(this,t)},enumerable:!1,configurable:!0}),k.prototype.toggleSelected=function(){this.el.classList.toggle(A),this.manager.emitElementSelect(this,this.selected)},k.prototype.setDragList=function(t){this.dragList=t},k.prototype.handleClick=function(t){var e,n=t.srcEvent;this.selectable&&(n.metaKey||n.ctrlKey||1===(e=this.manager.selectedItems).size&&e.has(this)?this.toggleSelected():(this.manager.cleanSelectedItems(),this.selected=!0))},k.prototype.handleDragStart=function(t){var e,n=this;null!=this.group&&(this.selectable?(this.selected||(this.selected=!0),e=Array.from(this.manager.selectedItems),this.draggingNodes=e.map(function(t){return n.genDraggingNode(t)})):this.draggingNodes=[this.genDraggingNode(this)],this.startPoint=t.center,this.manager.emitDragStart(this),this.renderDraggingNodes(),t.preventDefault())},k.prototype.handleDragMove=function(t){var e,n,r;null!=this.startPoint&&(e=t.center,n=e.x-this.startPoint.x,r=e.y-this.startPoint.y,this.draggingNodes.forEach(function(t){t.style.transform="translate3d("+n+"px, "+r+"px, 0)"}),this.manager.emitDragMove(t),t.preventDefault())},k.prototype.handleDragEnd=function(t){t.preventDefault(),this.startPoint=null,this.manager.emitDragEnd(t),this.disposeDraggingNodes()},k.prototype.genDraggingNode=function(t){var e=t.el.getBoundingClientRect(),n=t.el.cloneNode(!0);return n.instance=t,n.classList.add(G),n.style.left=e.left+"px",n.style.top=e.top+"px",n},k.prototype.renderDraggingNodes=function(){this.draggingNodes.forEach(function(t){t.instance.el.classList.add(w)});var t=document.createDocumentFragment();t.append.apply(t,this.draggingNodes),document.body.append(t)},k.prototype.disposeDraggingNodes=function(){null!=this.draggingNodes&&(this.draggingNodes.forEach(function(t){t.instance.el.classList.remove(w),t.remove()}),this.draggingNodes=null)},v([h],k.prototype,"manager",void 0),v([g("click")],k.prototype,"handleClick",null),v([g("dragstart")],k.prototype,"handleDragStart",null),v([g("dragmove")],k.prototype,"handleDragMove",null),v([g("dragend")],k.prototype,"handleDragEnd",null),v([p],k));function k(t){var e=x.call(this,t)||this;return e.el.setAttribute(n,""),e}var M=(C.prototype.bind=function(t,e){var n=e.value||{};t.instance=new O(t),t.instance.data=n.data,null!=n.groupName&&""!==n.groupName&&(t.instance.name=n.groupName)},C.prototype.inserted=function(t){var e=t.instance;e.collect(),d(e)},C.prototype.unbind=function(t){u(t.instance)},C);function C(){}var H=(q.prototype.bind=function(t,e){var n=e.value||{};t.instance=new T(t),t.instance.data=n.data},q.prototype.inserted=function(r){var t=r.instance;t.noticeDirty(S),d(t,function(t,e){var n=new CustomEvent(t,{detail:e});r.dispatchEvent(n)})},q.prototype.unbind=function(t){u(t.instance)},q);function q(){}var B=(K.prototype.bind=function(t,e){var n=e.value||{},r=new S(t);r.data=n.data,r.selectable=Boolean(n.selectable),r.groupName=n.group,t.instance=r},K.prototype.inserted=function(r){var t=r.instance;t.collect(),t.noticeDirty(O),d(t,function(t,e){var n=new CustomEvent(t,{detail:e});r.dispatchEvent(n)})},K.prototype.unbind=function(t){u(t.instance)},K);function K(){}t.DRAG_CLASS_PREFIX=e,t.DRAG_GROUP_ATTR_NAME="kb-drag-group",t.DRAG_ITEM_ATTR_NAME=n,t.DRAG_LIST_ATTR_NAME=r,t.EVENT_MAP=a,t.default=function(t){t.directive("drag-group",new M),t.directive("drag-item",new H),t.directive("drag-list",new B);var e=document.createElement("style");e.innerHTML="\n    ."+G+" {\n      position: fixed;\n      margin: 0;\n      box-shadow: 0 5px 5px -3px rgba(0, 0, 0, 0.2), 0 8px 10px 1px rgba(0, 0, 0, 0.14), 0 3px 14px 2px rgba(0, 0, 0, 0.12);\n    }\n\n    ."+w+" {\n      opacity: 0;\n    }\n  ",document.head.appendChild(e)},Object.defineProperty(t,"__esModule",{value:!0})});
